{% extends 'layout.html' %} {% block content %}
<h3>Staff Dashboard | Date: {{today}}</h3>
{% if current_period %}
<div class="alert alert-info">
  Current period: <strong>Period {{ current_period }}</strong>
</div>
{% endif %} {% if has_assigned_classes %}
<div class="alert alert-success">
  <i class="bi bi-info-circle"></i> Showing attendance for your assigned classes
  only
</div>
{% endif %}

<div class="mb-3">
  <a class="btn btn-outline-primary" href="/staff/export_excel"
    >Download Excel (today)</a
  >
  <a class="btn btn-warning" href="{{ url_for('change_password') }}">
    <i class="bi bi-key"></i> Change My Password
  </a>
  <a class="btn btn-outline-danger" href="{{ url_for('logout') }}">
    <i class="bi bi-box-arrow-right"></i> Logout
  </a>
</div>

{% for s in summary %}
<div class="card mb-4">
  <div
    class="card-header {% if s.current_period %}bg-info text-white{% else %}bg-light{% endif %}"
    style="cursor: pointer;"
    data-bs-toggle="collapse"
    data-bs-target="#class-{{loop.index}}"
    aria-expanded="false"
    aria-controls="class-{{loop.index}}"
  >
    <h5 class="mb-0">
      <i class="bi bi-collection"></i> {{s.class.name}} {% if s.current_period
      %}
      <span class="badge bg-warning text-dark ms-2"
        >Current: Period {{ s.current_period }}</span
      >
      {% endif %}
      <i class="bi bi-chevron-down float-end"></i>
    </h5>
  </div>
  <div id="class-{{loop.index}}" class="collapse">
    <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="text-center p-3 bg-light rounded">
          <h6 class="text-muted mb-1">Total Students</h6>
          <h3 class="mb-0">{{s.total}}</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="text-center p-3 bg-success text-white rounded">
          <h6 class="mb-1">Present</h6>
          <h3 class="mb-0">{{s.present}}</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="text-center p-3 bg-danger text-white rounded">
          <h6 class="mb-1">Absent</h6>
          <h3 class="mb-0">{{s.absent}}</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="text-center p-3 bg-secondary text-white rounded">
          <h6 class="mb-1">Not Recorded</h6>
          <h3 class="mb-0">{{s.not_recorded}}</h3>
        </div>
      </div>
    </div>

    <h6 class="mb-2">Period-wise Attendance Summary</h6>
    <div class="table-responsive mb-3">
      <table class="table table-sm table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th>Period</th>
            {% for period in s.period_counts.keys()|sort %}
            <th>P{{period}}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="fw-bold">Present</td>
            {% for period in s.period_counts.keys()|sort %}
            <td class="bg-success bg-opacity-10">
              <strong class="text-success">{{s.period_counts[period]['present']}}</strong>
            </td>
            {% endfor %}
          </tr>
          <tr>
            <td class="fw-bold">Absent</td>
            {% for period in s.period_counts.keys()|sort %}
            <td class="bg-danger bg-opacity-10">
              <strong class="text-danger">{{s.period_counts[period]['absent']}}</strong>
            </td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <h6 class="mb-2">Student Attendance Details</h6>
    <div class="table-responsive">
      <table class="table table-sm table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Student Name</th>
            {% for period in s.period_counts.keys()|sort %}
            <th class="text-center">P{{period}}</th>
            {% endfor %}
            <th class="text-center">Overall</th>
            <th class="text-center">Remark</th>
          </tr>
        </thead>
        <tbody>
          {% for item in s.students %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>
              <strong>{{item.student.name}}</strong>
              {% if item.student.national_id %}
              <br /><small class="text-muted"
                >ID: {{item.student.national_id}}</small
              >
              {% endif %}
            </td>
            {% for period in s.period_counts.keys()|sort %}
            <td
              class="text-center {% if item.period_status.get(period) == 'present' %}table-success{% elif item.period_status.get(period) == 'absent' %}{% if item.period_remarks.get(period) == 'excused' %}table-warning{% else %}table-danger{% endif %}{% endif %}"
            >
              {% if item.period_status.get(period) == 'present' %}
              <span class="badge bg-success">P</span>
              {% elif item.period_status.get(period) == 'absent' %}
              {% if item.period_remarks.get(period) == 'excused' %}
              <span class="badge bg-warning text-dark">E</span>
              {% else %}
              <span class="badge bg-danger">A</span>
              {% endif %}
              {% if item.period_remarks.get(period) %}
              <br /><small class="text-muted fst-italic">{{item.period_remarks.get(period)}}</small>
              {% endif %}
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            {% endfor %}
            <td class="text-center">
              {% if item.overall_status == 'absent' %}
              <span class="badge bg-danger">Absent</span>
              {% elif item.overall_status == 'present' %}
              <span class="badge bg-success">Present</span>
              {% else %}
              <span class="badge bg-secondary">Not Recorded</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if item.overall_status == 'absent' %}
              <!-- Show remark form for absent students -->
              <form method="POST" action="/staff/update_remark" class="d-inline">
                <input type="hidden" name="student_id" value="{{item.student.id}}" />
                <input type="hidden" name="date" value="{{today}}" />
                <input type="hidden" name="class_id" value="{{s.class.id}}" />
                <!-- Find first absent period that is not excused -->
                {% set absent_period = namespace(value=0) %}
                {% for period in s.period_counts.keys()|sort %}
                  {% if item.period_status.get(period) == 'absent' and item.period_remarks.get(period) != 'excused' and absent_period.value == 0 %}
                    {% set absent_period.value = period %}
                  {% endif %}
                {% endfor %}
                <input type="hidden" name="period" value="{{absent_period.value}}" />
                <select name="remark" class="form-select form-select-sm" onchange="this.form.submit()">
                  <option value="">-- Select --</option>
                  <option value="excused" {% if item.period_remarks.get(absent_period.value) == 'excused' %}selected{% endif %}>Excused</option>
                  <option value="still absent" {% if item.period_remarks.get(absent_period.value) == 'still absent' %}selected{% endif %}>Still Absent</option>
                </select>
              </form>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  </div>
</div>
{% endfor %} {% if not summary %}
<div class="alert alert-warning">
  <i class="bi bi-exclamation-triangle"></i> No classes assigned or available.
</div>
{% endif %} {% endblock %}
